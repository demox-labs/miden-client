<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WASM Example</title>
</head>
<body>
    <label for="accountFileInput" class="custom-file-upload">
        Choose Account File
    </label>
    <input type="file" id="accountFileInput" style="display: none;">
    <label for="noteFileInput" class="custom-file-upload">
        Choose Note File
    </label>
    <input type="file" id="noteFileInput" style="display: none;">
    <script type="module" src="./dist/index.js"></script>
    <script type="module">
        // Example of using the exported WebClient in the browser
        import { WebClient } from './dist/index.js';

        document.getElementById('accountFileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
            const reader = new FileReader();

            reader.onload = async function(e) {
                let webClient = await createMidenWebClient();
                const arrayBuffer = e.target.result;
                const byteArray = new Uint8Array(arrayBuffer);
                console.log(byteArray);  // Now you can work with the bytes

                await testImportAccount(webClient, byteArray);
            };

            reader.readAsArrayBuffer(file);
            }
        });
        
        function setupNoteFileInputListener(webClient) {
            document.getElementById('noteFileInput').addEventListener('change', function(event) {
                const file = event.target.files[0];
                if (file) {
                const reader = new FileReader();

                reader.onload = async function(e) {
                    const arrayBuffer = e.target.result;
                    const byteArray = new Uint8Array(arrayBuffer);
                    console.log(byteArray);  // Now you can work with the bytes

                    let result = await importInputNote(webClient, byteArray);
                    console.log(result);
                };

                reader.readAsArrayBuffer(file);
                }
            });
        }
        
        async function createMidenWebClient() {
            try {
                let local_rpc_url = "http://localhost:57291"
                let envoy_proxy_url = "http://localhost:8080"
                const webClient = new WebClient();
                await webClient.create_client(local_rpc_url);
                return webClient;
            } catch (error) {
                console.error('Failed to create client with web store:', error);
            }
        }

        async function testStoreAndRpc(webClient) {
            try {
                await webClient.test_store_and_rpc();
            } catch (error) {
                console.error('Failed to create client with web store:', error);
            }
        }

        // Account Functions 
        ///////////////////////////////////////////////////////////////////

        async function createNewWallet(
            webClient,
            storageMode,
            mutable
        ) {
            try {
                let result = await webClient.new_wallet(storageMode, mutable);
                console.log(`Created new wallet account with id ${result}`);
                return result;
            } catch (error) {
                console.error('Failed to call create account:', error);
            }
        }

        async function createNewFaucet(
            webClient,
            storageMode,
            nonFungible,
            tokenSymbol,
            decimals,
            maxSupply
        ) {
            try {
                let result = await webClient.new_faucet(
                    storageMode,
                    nonFungible,
                    tokenSymbol,
                    decimals,
                    maxSupply
                );
                console.log(`Created new wallet account with id ${result}`);
                return result;
            } catch (error) {
                console.error('Failed to call create account:', error);
            }
        }

        async function importAccount(
            webClient, 
            accountAsBytes
        ) {
            try {
                let result = await webClient.import_account(accountAsBytes);
                console.log(result);
                return result;
            } catch (error) {
                console.error('Failed to call import account:', error);
            }
        }

        async function getAccounts(webClient) {
            try {
                let accounts = await webClient.get_accounts();
                let accountIds = accounts.map(account => account.id);
                console.log(accountIds)
                return accountIds;
            } catch (error) {
                console.error('Failed to call get accounts:', error);
            }
        }

        async function getAccount(
            webClient,
            accountId
        ) {
            try {
                let result = await webClient.get_account(accountId);
                console.log(result);
                return result;
            } catch (error) {
                console.error('Failed to call get account:', error);
            }
        }

        // Transaction Functions
        ///////////////////////////////////////////////////////////////////

        async function createNewMintTransaction(
            webClient,
            targetAccountId,
            faucetId,
            noteType,
            amount
        ) {
            try {
                let result = await webClient.new_mint_transaction(
                    targetAccountId,
                    faucetId,
                    noteType,
                    amount
                );
                console.log(`Created new mint transaction with id ${result.transaction_id}`);
                console.log(`Output notes created: ${result.created_note_ids}`);
                return result;
            } catch (error) {
                console.error('Failed to call create new mint transaction:', error);
            }
        }

        async function createNewConsumeTransaction(
            webClient,
            accountId,
            listOfNotes
        ) {
            try {
                let result = await webClient.new_consume_transaction(accountId, listOfNotes);
                console.log(`Created new consume transaction with id ${result.transaction_id}`);
                console.log(`Output notes created: ${result.created_note_ids}`);
                return result;
            } catch (error) {
                console.error('Failed to call create new consume transaction:', error);
            }
        }

        async function createNewSendTransaction(
            webClient,
            senderAccountId,
            targetAccountId,
            facuetId,
            noteType,
            amount,
            recallHeight
        ) {
            try {
                let result = await webClient.new_send_transaction();
                console.log(`Created new send transaction with id ${result.transaction_id}`);
                console.log(`Output notes created: ${result.created_note_ids}`);
                return result;
            } catch (error) {
                console.error('Failed to call create new send transaction:', error);
            }
        }

        async function createNewSwapTransaction(
            webClient,
            senderAccountId,
            offeredAssetFaucetId,
            offeredAssetAmount,
            requestedAssetFaucetId,
            requestedAssetAmount,
            noteType
        ) {
            try {
                let result = await webClient.new_swap_transaction(
                    senderAccountId,
                    offeredAssetFaucetId,
                    offeredAssetAmount,
                    requestedAssetFaucetId,
                    requestedAssetAmount,
                    noteType
                );
                console.log(`Created new swap transaction with id ${result.transaction_id}`);
                console.log(`Output notes created: ${result.created_note_ids}`);
                return result;
            } catch (error) {
                console.error('Failed to call create new swap transaction:', error);
            }
        }

        async function getTransactions(
            webClient,
        ) {
            try {
                let result = await webClient.get_transactions();
                console.log(result);
                return result;
            } catch (error) {
                console.error('Failed to call get transactions:', error);
            }
        }

        // Note Functions
        ///////////////////////////////////////////////////////////////////

        async function getInputNotes(
            webClient,
            status = "All"
        ) {
            try {
                let result = await webClient.get_input_notes(status);
                console.log(result);
                return result;
            } catch (error) {
                console.error('Failed to call get input notes:', error);
            }
        }

        async function getInputNote(
            webClient,
            noteId
        ) {
            try {
                let result = await webClient.get_input_note(noteId);
                console.log(result);
                return result;
            } catch (error) {
                console.error('Failed to call get input note:', error);
            }
        }

        async function importInputNote(
            webClient,
            noteAsBytes
        ) {
            try {
                await webClient.import_input_note(noteAsBytes);
            } catch (error) {
                console.error('Failed to call import input note:', error);
            }
        }

        async function exportInputNote(
            webClient,
            noteId
        ) {
            try {
                let result = await webClient.export_input_note(noteId);
                console.log(result);
            } catch (error) {
                console.error('Failed to call export input note:', error);
            }
        }

        // Sync Functions
        ///////////////////////////////////////////////////////////////////

        async function syncState(webClient) {
            try {
                let result = await webClient.sync_state();
                console.log('Synced state to block ', result);
            } catch (error) {
                console.error('Failed to call sync state:', error);
            }
        }

        // Tests
        ///////////////////////////////////////////////////////////////////

        // Done
        async function testCreateNewWallet() {
            console.log('testCreateNewWallet started');
            let webClient = await createMidenWebClient();

            await createNewWallet(webClient, "OffChain", true);

            console.log('testCreateNewWallet finished');
        }

        async function testCreateNewFaucet() {
            console.log('testCreateNewFaucet started');
            let webClient = await createMidenWebClient();

            await createNewFaucet(
                webClient,
                "OffChain",
                false,
                "DEN",
                "10",
                "1000000"
            );

            console.log('testCreateNewFaucet finished');
        }

        async function testImportAccount(webClient, accountAsBytes) {
            console.log('testImportAccount started');
            await importAccount(webClient, accountAsBytes);
            console.log('testImportAccount finished');
        }

        async function testGetAccounts(shouldCreateAccounts = true) {
            console.log('testGetAccounts started');
            let webClient = await createMidenWebClient();
            if (shouldCreateAccounts) {
                await createNewWallet(webClient, "OffChain", true);
            }

            await getAccounts(webClient);

            console.log('testGetAccounts finished');
        }

        async function testGetAccount(shouldCreateAccount = true, accountId = null) {
            console.log('testGetAccount started');
            let webClient = await createMidenWebClient();
            if (shouldCreateAccount) {
                accountId = await createNewWallet(webClient, "OffChain", true);
            }

            await getAccount(webClient, accountId);

            console.log('testGetAccount finished');
        }

        async function testNewMintTransaction(shouldCreateAccounts = true, targetAccountId = null, faucetId = null) {
            console.log('testNewMintTransaction started');
            let webClient = await createMidenWebClient();
            if (shouldCreateAccounts) {
                targetAccountId = await createNewWallet(webClient, "OffChain", true);
                faucetId = await createNewFaucet(webClient, "OffChain", false, "DEN", "10", "1000000");
            }
            await syncState(webClient);
            await new Promise(r => setTimeout(r, 10000));

            let result = await createNewMintTransaction(
                webClient,
                targetAccountId,
                faucetId,
                "Private",
                "1000"
            );
            await new Promise(r => setTimeout(r, 10000));
            await syncState(webClient);
            console.log('testNewMintTransaction finished');
        }

        async function testNewConsumeTransaction() {
            console.log('testNewConsumeTransaction started');
            let webClient = await createMidenWebClient();
            let targetAccountId = await createNewWallet(webClient, "OffChain", true);
            let faucetId = await createNewFaucet(webClient, "OffChain", false, "DEN", "10", "1000000");
            await syncState(webClient);
            await new Promise(r => setTimeout(r, 10000));

            let mintTransactionResult = await createNewMintTransaction(
                webClient,
                targetAccountId,
                faucetId,
                "Private",
                "1000"
            );
            await new Promise(r => setTimeout(r, 10000));
            await syncState(webClient);

            let consumeTransactionResult = await createNewConsumeTransaction(
                webClient,
                targetAccountId,
                mintTransactionResult.created_note_ids
            );
            await new Promise(r => setTimeout(r, 10000));
            await syncState(webClient);
            console.log('testNewMintTransaction finished');
        }

        async function testNewSendTransaction() {
            console.log('testNewSendTransaction started');
            let webClient = await createMidenWebClient();
            let senderAccountId = await createNewWallet(webClient, "OffChain", true);
            let targetAccountId = await createNewWallet(webClient, "OffChain", true);
            let faucetId = await createNewFaucet(webClient, "OffChain", false, "DEN", "10", "1000000");
            await syncState(webClient);
            await new Promise(r => setTimeout(r, 10000));

            let mintTransactionResult = await createNewMintTransaction(
                webClient,
                senderAccountId,
                faucetId,
                "Private",
                "1000"
            );
            await new Promise(r => setTimeout(r, 10000));
            await syncState(webClient);

            let consumeTransactionResult = await createNewConsumeTransaction(
                webClient,
                senderAccountId,
                mintTransactionResult.created_note_ids
            );
            await new Promise(r => setTimeout(r, 10000));
            await syncState(webClient);

            let sendTransactionResult = await createNewSendTransaction(
                webClient,
                senderAccountId,
                targetAccountId,
                faucetId,
                "Private",
                "500"
            );
            await new Promise(r => setTimeout(r, 10000));
            await syncState(webClient);

            let consumeSendTransactionResult = await createNewConsumeTransaction(
                webClient,
                targetAccountId,
                sendTransactionResult.created_note_ids
            );
            await new Promise(r => setTimeout(r, 10000));
            await syncState(webClient);
            console.log('testNewSendTransaction finished');
        }

        async function testNewSendTransactionWithRecallHeight() {
            console.log('testNewSendTransactionWithRecallHeight started');
            let webClient = await createMidenWebClient();
            let senderAccountId = await createNewWallet(webClient, "OffChain", true);
            let targetAccountId = await createNewWallet(webClient, "OffChain", true);
            let faucetId = await createNewFaucet(webClient, "OffChain", false, "DEN", "10", "1000000");
            await syncState(webClient);
            await new Promise(r => setTimeout(r, 10000));

            let mintTransactionResult = await createNewMintTransaction(
                webClient,
                senderAccountId,
                faucetId,
                "Private",
                "1000"
            );
            await new Promise(r => setTimeout(r, 10000));
            await syncState(webClient);

            let consumeTransactionResult = await createNewConsumeTransaction(
                webClient,
                senderAccountId,
                mintTransactionResult.created_note_ids
            );
            await new Promise(r => setTimeout(r, 10000));
            await syncState(webClient);

            let sendTransactionResult = await createNewSendTransaction(
                webClient,
                senderAccountId,
                targetAccountId,
                faucetId,
                "Private",
                "500",
                "0"
            );
            await new Promise(r => setTimeout(r, 10000));
            await syncState(webClient);

            let consumeSendTransactionResult = await createNewConsumeTransaction(
                webClient,
                senderAccountId,
                sendTransactionResult.created_note_ids
            );
            await new Promise(r => setTimeout(r, 10000));
            await syncState(webClient);
            console.log('testNewSendTransactionWithRecallHeight finished');
        }

        // async function testNewSwapTransaction() {
        //     console.log('testNewSwapTransaction started');
        //     let webClient = await createMidenWebClient();
        //     let senderAccountId = await createNewWallet(webClient, "OffChain", true);
        //     let offeredAssetFaucetId = await createNewFaucet(webClient, "OffChain", false, "DEN", "10", "1000000");
        //     let requestedAssetFaucetId = await createNewFaucet(webClient, "OffChain", false, "GAR", "10", "1000000");
        //     await syncState(webClient);
        //     await new Promise(r => setTimeout(r, 10000));

        //     let mintTransactionResult = await createNewMintTransaction(
        //         webClient,
        //         senderAccountId,
        //         offeredAssetFaucetId,
        //         "Private",
        //         "1000"
        //     );
        //     await new Promise(r => setTimeout(r, 10000));
        //     await syncState(webClient);

        //     let consumeTransactionResult = await createNewConsumeTransaction(
        //         webClient,
        //         senderAccountId,
        //         mintTransactionResult.created_note_ids
        //     );
        //     await new Promise(r => setTimeout(r, 10000));
        //     await syncState(webClient);

        //     let swapTransactionResult = await createNewSwapTransaction(
        //         webClient,
        //         senderAccountId,
        //         offeredAssetFaucetId,
        //         "500",
        //         requestedAssetFaucetId,
        //         "500",
        //         "Private"
        //     );
        //     await new Promise(r => setTimeout(r, 10000));
        //     await syncState(webClient);

        //     let consumeSwapTransactionResult = await createNewConsumeTransaction(
        //         webClient,
        //         senderAccountId,
        //         swapTransactionResult.created_note_ids
        //     );
        //     await new Promise(r => setTimeout(r, 10000));
        //     await syncState(webClient);
        //     console.log('testNewSwapTransaction finished');
        // }
        
        async function testGetTransactions() {
            console.log("testGetTransactions started");
            let webClient = await createMidenWebClient();
            let walletAccount = await createNewWallet(webClient, "OffChain", true);
            let faucetAccount = await createNewFaucet(webClient, "OffChain", false, "DEN", "10", "1000000");
            await syncState(webClient);
            await new Promise(r => setTimeout(r, 10000));
            
            let mintTransactionResult = await createNewMintTransaction(
                webClient,
                walletAccount,
                faucetAccount,
                "Private",
                "1000"
            );
            await new Promise(r => setTimeout(r, 20000));
            await syncState(webClient);

            let consumeTransactionResult = await createNewConsumeTransaction(
                webClient,
                walletAccount,
                mintTransactionResult.created_note_ids
            );
            await new Promise(r => setTimeout(r, 20000));
            await syncState(webClient);

            await getTransactions(webClient);

            console.log("testGetTransactions finished");
        }

        async function testGetNotes() {
            console.log("testGetNotes started");
            let webClient = await createMidenWebClient();

            // Create accounts and sync
            let regularAccountTemplate = createBasicMutableAccountTemplate("Local");
            let fungibleFaucetAccountTemplate = createFungibleFaucetAccountTemplate(
                "DEN",
                "10",
                "1000000",
                "Local"
            );
            let regularAccountId = await createNewAccount(webClient, regularAccountTemplate);
            let faucetId = await createNewAccount(webClient, fungibleFaucetAccountTemplate);
            await syncState(webClient);
            await new Promise(r => setTimeout(r, 10000));

            // Create mint transaction and sync
            let transactionTemplate = createMintTransactionTemplate(
                regularAccountId,
                faucetId,
                "1000",
                "Private"
            );
            let createTransactionResult = await createTransaction(webClient, transactionTemplate);
            await new Promise(r => setTimeout(r, 10000));
            await syncState(webClient);

            // Create mint transaction and sync
            let transactionTemplate2 = createMintTransactionTemplate(
                regularAccountId,
                faucetId,
                "1000",
                "Private"
            );
            let createTransactionResult2 = await createTransaction(webClient, transactionTemplate2);
            await new Promise(r => setTimeout(r, 10000));
            await syncState(webClient);

            await getInputNotes(webClient);

            console.log("testGetNotes finished");
        }
        
        async function testGetNote() {
            console.log("testGetNote started");
            let webClient = await createMidenWebClient();

            // Create accounts and sync
            let regularAccountTemplate = createBasicMutableAccountTemplate("Local");
            let fungibleFaucetAccountTemplate = createFungibleFaucetAccountTemplate(
                "DEN",
                "10",
                "1000000",
                "Local"
            );
            let regularAccountId = await createNewAccount(webClient, regularAccountTemplate);
            let faucetId = await createNewAccount(webClient, fungibleFaucetAccountTemplate);
            await syncState(webClient);
            await new Promise(r => setTimeout(r, 10000));

            // Create mint transaction and sync
            let transactionTemplate = createMintTransactionTemplate(
                regularAccountId,
                faucetId,
                "1000",
                "Private"
            );
            let createTransactionResult = await createTransaction(webClient, transactionTemplate);
            await new Promise(r => setTimeout(r, 10000));
            await syncState(webClient);

            await getInputNote(webClient, createTransactionResult.created_note_ids[0]);

            console.log("testGetNote finished");
        }
        
        async function testExportInputNote() {
            console.log("testExportInputNote started");
            let webClient = await createMidenWebClient();

            // Create accounts and sync
            let senderAccountTemplate = createBasicMutableAccountTemplate("Local");
            let faucetAccountTemplate = createFungibleFaucetAccountTemplate(
                "DEN",
                "10",
                "1000000",
                "Local"
            );
            let senderAccountId = await createNewAccount(webClient, senderAccountTemplate);
            let faucetId = await createNewAccount(webClient, faucetAccountTemplate);
            await syncState(webClient);
            await new Promise(r => setTimeout(r, 10000));

            // Create mint transaction and sync
            let mintTransactionTemplate = createMintTransactionTemplate(
                senderAccountId,
                faucetId,
                "1000",
                "Private"
            );
            let mintTransactionResult = await createTransaction(webClient, mintTransactionTemplate);
            // await new Promise(r => setTimeout(r, 20000));
            // await syncState(webClient);

            // // Create consume transaction and sync
            // let consumeMintedAssetsTransactionTemplate = createConsumeNotesTransactionTemplate(
            //     senderAccountId,
            //     mintTransactionResult.created_note_ids
            // );
            // await createTransaction(webClient, consumeMintedAssetsTransactionTemplate);
            // await new Promise(r => setTimeout(r, 20000));
            // await syncState(webClient);

            // // Create P2ID transaction and sync
            // let p2idTransactionTemplate = createP2IDTransactionTemplate(
            //     senderAccountId,
            //     "0x9f148e149de3e776",
            //     faucetId,
            //     "500",
            //     "Private"
            // );
            // let p2idTransactionResult = await createTransaction(webClient, p2idTransactionTemplate);
            // await new Promise(r => setTimeout(r, 20000));
            // await syncState(webClient);

            // console.log(p2idTransactionResult);
            // console.log(p2idTransactionResult.created_note_ids);
            // console.log(p2idTransactionResult.created_note_ids[0]);
            // let result = await exportInputNote(webClient, p2idTransactionResult.created_note_ids[0]);

            // const blob = new Blob([result], {type: 'application/octet-stream'});

            // // Create a URL for the Blob
            // const url = URL.createObjectURL(blob);

            // // Create a temporary anchor element
            // const a = document.createElement('a');
            // a.href = url;
            // a.download = 'note.mno'; // Specify the file name

            // // Append the anchor to the document
            // document.body.appendChild(a);

            // // Programmatically click the anchor to trigger the download
            // a.click();

            // // Remove the anchor from the document
            // document.body.removeChild(a);

            // // Revoke the object URL to free up resources
            // URL.revokeObjectURL(url);

            // console.log("testExportInputNote finished");
        }
       
        async function testImportInputNote() {
            let webClient = await createMidenWebClient();

            setupNoteFileInputListener(webClient);

            let regularAccountTemplate = await createBasicMutableAccountTemplate("Local");
            await createNewAccount(webClient, regularAccountTemplate);

            // Create consume transaction and sync
            // let consumeTransactionTemplate = createConsumeNotesTransactionTemplate(
            //     "0x912ea536cab38f1b",
            //     ["0x8888c1474034b1aad083b58642d3547e7fea9c2b4061087d8ae128ef0a6ae3ca"]
            // );
            // await createTransaction(webClient, consumeTransactionTemplate);
            // await new Promise(r => setTimeout(r, 10000));
            // await syncState(webClient);
        }

        // await testCreateNewWallet();
        // await testCreateNewFaucet();
        // await testGetAccounts(false);
        // await testGetAccount(false, "0x8add712899d6ab76");
        await testNewMintTransaction(false,  "0x8add712899d6ab76", "0x20421649f243d662");
        // await testNewConsumeTransaction();
        // await testNewSendTransaction();
        // await testNewSendTransactionWithRecallHeight();
        // await testNewSwapTransaction();
        // await testGetTransactions();

        // await testCreateAllAccountTypes();
        // await testGetAccount();
        // await testGetAccounts();
        // await testGetNotes();
        // await testGetNote();
        // await testExportInputNote();
        // await testMintAsset();
        // await testP2IDTransaction();
        // await testP2IDRTransaction();
        // await testGetTransactions();
        // await testImportInputNote();

    </script>
</body>
</html>