<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>WASM Example</title>
</head>
<body>
    <input type="file" id="fileInput">
    <script type="module" src="./dist/index.js"></script>
    <script type="module">
        // Example of using the exported WebClient in the browser
        import { WebClient } from './dist/index.js';

        document.getElementById('fileInput').addEventListener('change', function(event) {
            const file = event.target.files[0];
            if (file) {
            const reader = new FileReader();

            reader.onload = async function(e) {
                const arrayBuffer = e.target.result;
                const byteArray = new Uint8Array(arrayBuffer);
                console.log(byteArray);  // Now you can work with the bytes

                let result = await testImportAccount(webClient, byteArray);
                console.log(result);
            };

            reader.readAsArrayBuffer(file);
            }
        });
        
        async function testCreateClient() {
            try {
                const webClient = new WebClient();
                await webClient.create_client();
                return webClient;
            } catch (error) {
                console.error('Failed to create client with web store:', error);
            }
        }

        async function testStoreAndRpc(webClient) {
            try {
                await webClient.test_store_and_rpc();
            } catch (error) {
                console.error('Failed to create client with web store:', error);
            }
        }

        // Accounts Tests

        async function testNewRegularAccount(webClient) {
            const basicMutableTemplate = {
                type: "BasicMutable"
            };
            try {
                let result = await webClient.new_account(basicMutableTemplate);
                return result;
            } catch (error) {
                console.error('Failed to call create account:', error);
            }
        }

        async function testNewFaucetAccount(webClient) {
            const fungibleFaucetTemplate = {
                type: "FungibleFaucet",
                token_symbol: "TEST",
                decimals: "10",
                max_supply: "1000000"
            };
            try {
                let result = await webClient.new_account(fungibleFaucetTemplate);
                return result;
            } catch (error) {
                console.error('Failed to call create account:', error);
            }
        }

        async function testImportAccount(webClient, accountAsBytes) {
            try {
                let result = await webClient.import_account(accountAsBytes);
                console.log(result);

            } catch (error) {
                console.error('Failed to call import account:', error);
            }
        }

        async function testGetAccounts(webClient) {
            try {
                let result = await webClient.get_accounts();
                console.log(result);

            } catch (error) {
                console.error('Failed to call get accounts:', error);
            
            }
        }

        async function testGetAccount(webClient) {
            try {
                let result = await webClient.get_account("0x9daeab54109472e8");
                console.log(result);

            } catch (error) {
                console.error('Failed to call get account:', error);
            
            }
        }

        async function testGetAccountStubById(webClient) {
            try {
                let result = await webClient.get_account_stub_by_id("0x8d911ae1789cdb33");
                console.log(result);

            } catch (error) {
                console.error('Failed to call get account stub by id:', error);
            
            }
        }

        async function testGetAccountAuth(webClient) {
            try {
                let result = await webClient.get_account_auth("0x8d911ae1789cdb33");
                console.log(result);

            } catch (error) {
                console.error('Failed to call get account auth:', error);
            
            }
        }

        // Notes Tests

        async function testGetInputNotes(webClient) {
            try {
                await webClient.get_input_notes("Pending");

            } catch (error) {
                console.error('Failed to call get input notes:', error);
            
            }
        }

        async function testGetInputNote(webClient) {
            try {
                await webClient.get_input_note("TestString");

            } catch (error) {
                console.error('Failed to call get input note:', error);
            
            }
        }

        async function testImportInputNote(webClient) {
            try {
                await webClient.import_input_note(new Uint8Array(32));

            } catch (error) {
                console.error('Failed to call import input note:', error);
            
            }
        }

        // Transaction Tests

        async function testGetTransactions(webClient) {
            try {
                await webClient.get_transactions("All");

            } catch (error) {
                console.error('Failed to call get transactions:', error);
            
            }
        }

        async function testNewTransaction(
            webClient,
            targetAccountId,
            faucetAccountId
        ) {
            try {
                const mintTransactionTemplate = {
                    type: "Mint",
                    target_account_id: targetAccountId,
                    faucet_id: faucetAccountId,
                    amount: "1000",
                    note_type: "Private",
                };
                let result = await webClient.new_transaction(mintTransactionTemplate);
                console.log(result);

            } catch (error) {
                console.error('Failed to call new transaction:', error);
            
            }
        }

        async function testNewConsumeTransaction(
            webClient,
            targetAccountId,
            listOfNotes
        ) {
            try {
                const consumeTransactionTemplate = {
                    type: "ConsumeNotes",
                    account_id: targetAccountId,
                    list_of_notes: listOfNotes
                };
                let result = await webClient.new_transaction(consumeTransactionTemplate);
                console.log(result);

            } catch (error) {
                console.error('Failed to call new transaction:', error);
            
            }
        }

        async function testSyncState(webClient) {
            try {
                let result = await webClient.sync_state();
                console.log(result);
            } catch (error) {
                console.error('Failed to call sync state:', error);
            
            }
        }

        let webClient = await testCreateClient();
        //await testStoreAndRpc(webClient);

        // let regularAccount = await testNewRegularAccount(webClient);
        // let faucetAccount = await testNewFaucetAccount(webClient);
        // await testGetAccounts(webClient);
        // await testGetAccount(webClient);
        // await testGetAccountStubById(webClient);
        // await testGetAccountAuth(webClient);

        // await testGetInputNotes(webClient);
        // await testGetInputNote(webClient);
        // await testImportInputNote(webClient);

        // await testGetTransactions(webClient);

        let regularAccount = await testNewRegularAccount(webClient);
        let faucetAccount = await testNewFaucetAccount(webClient);
        await testSyncState(webClient);
        await testNewTransaction(webClient, regularAccount, faucetAccount);
        // await testSyncState(webClient);
        
        // await testNewConsumeTransaction(webClient, "0x92e4bd025c6a9aa0", ["0xadc497ac1478c8ae73c7a10b6c91843124351edbe31c06634fdad4f2fb381874"])
        // await testSyncState(webClient);

    </script>
</body>
</html>